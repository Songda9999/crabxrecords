<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CrabX 聊天记录抓取工具</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    html, body {
      margin: 0 !important;
      padding: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      display: block !important;
      background-color: white !important;
    }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] { -moz-appearance: textfield; }

    pre { white-space: pre-wrap; word-wrap: break-word; }
  </style>
</head>

<body class="bg-gray-100">

  <!-- Mobile notice -->
  <div class="flex sm:hidden h-full w-full items-center justify-center bg-gray-50 text-gray-700 p-8">
    <div class="text-center">
      <i class="fas fa-mobile-alt text-6xl mb-4" style="color:#F7931A;"></i>
      <h1 class="text-2xl font-bold mb-2">手机视图暂不支持</h1>
      <p class="text-base text-gray-600">请在网页版浏览器中打开此应用以获得最佳体验。</p>
    </div>
  </div>

  <!-- Desktop app -->
  <div class="hidden sm:flex h-full w-full bg-white shadow-xl rounded-2xl overflow-hidden">
    <!-- Left panel -->
    <div class="flex flex-col w-1/4 min-w-[250px] p-4 border-r border-gray-200 bg-gray-50">
      <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center justify-between">
        CrabX 工单查询工具
        <i class="fas fa-comment-dots text-2xl" style="color:#F7931A;"></i>
      </h2>

      <div class="flex items-center gap-2 mb-4">
        <input
          type="number"
          id="ticketIdInput"
          placeholder="输入 Ticket ID"
          class="flex-grow p-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 text-sm shadow-inner transition-all duration-200"
          style="--tw-ring-color:#F7931A; --tw-ring-opacity:1;"
        >
        <button
          id="fetchButton"
          class="text-white font-semibold py-2 px-4 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-md hover:shadow-lg text-sm"
          style="background-color:#F7931A; color:#ffffff;"
        >
          <i class="fas fa-search"></i>
        </button>
      </div>

      <div id="statusMessage" class="text-center text-red-500 p-1 font-medium text-xs"></div>

      <!-- Guide -->
      <div class="bg-white rounded-xl shadow-md p-4 mt-2 mb-6 border border-gray-200">
        <h3 class="text-lg font-bold text-gray-800 mb-2 flex items-center">
          <i class="fas fa-info-circle mr-2" style="color:#F7931A;"></i>
          使用指南
        </h3>
        <p class="text-sm text-gray-600 mb-2">1. 在上方输入框中粘贴 Zendesk Ticket ID。</p>
        <p class="text-sm text-gray-600 mb-2">2. 点击搜索按钮或按 Enter 键开始查询。</p>
        <p class="text-sm text-gray-600">3. 聊天记录将显示在右侧面板，并自动计算“专员平均响应时长”。</p>
      </div>

      <!-- How to find ticket id -->
      <div class="bg-white rounded-xl shadow-md p-4 mt-2 mb-6 border border-gray-200">
        <h3 class="flex items-center w-full text-lg font-bold text-gray-800 mb-2">
          <i class="fas fa-search-location mr-2" style="color:#F7931A;"></i>
          <span>如何查找 Ticket ID?</span>
        </h3>
        <div class="mt-2 text-sm text-gray-600">
          <p class="mb-2">在 Zendesk 中，Ticket ID 是用于唯一标识工单或聊天会话的数字。最简单的方法是查看浏览器地址栏中的 URL。</p>
          <ol class="list-decimal list-inside">
            <li>打开 Zendesk 聊天或工单页面。</li>
            <li>查看 URL：地址栏中会显示类似下面的 URL：</li>
            <pre class="bg-gray-100 p-2 my-2 rounded-md text-xs font-mono">https://crabex.zendesk.com/agent/tickets/12345</pre>
            <li>识别 ID：URL 中 /agent/tickets/ 后的数字即为 Ticket ID。例如：12345。</li>
          </ol>
        </div>
      </div>

      <div class="flex-1 overflow-y-auto no-scrollbar"></div>
    </div>

    <!-- Right panel -->
    <div class="flex-1 overflow-y-auto p-4 flex flex-col items-center">
      <!-- Metrics box -->
      <div id="metricsBox" class="w-full max-w-2xl mb-3 hidden">
        <div class="bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm">
          <div class="flex flex-wrap gap-6">
            <div>
              <div class="text-gray-500 text-xs">专员平均响应时长</div>
              <div id="avgAgentReply" class="font-bold text-gray-800">--</div>
            </div>
            <div>
              <div class="text-gray-500 text-xs">有效轮次</div>
              <div id="validRounds" class="font-bold text-gray-800">--</div>
            </div>
          </div>
          <div class="mt-2 text-xs text-gray-500">
            口径：仅统计“用户发言 → 下一条专员回复”。不含客服主动开场白/系统提示/内部备注。
          </div>
        </div>
      </div>

      <div id="chat-log" class="w-full max-w-2xl no-scrollbar font-mono text-sm leading-relaxed whitespace-pre-wrap">
        <div id="initial-message" class="text-center text-gray-600 mt-24">
          <img src="https://i.ibb.co/DDYLr0cv/icons8-search-512.png" alt="放大镜图标" class="mx-auto w-24 h-24 mb-4">
          <p class="text-base">请输入 Ticket ID 查看聊天记录...</p>
        </div>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const ticketIdInput = document.getElementById('ticketIdInput');
  const fetchButton = document.getElementById('fetchButton');
  const chatLog = document.getElementById('chat-log');
  const statusMessage = document.getElementById('statusMessage');

  const metricsBox = document.getElementById('metricsBox');
  const avgAgentReply = document.getElementById('avgAgentReply');
  const validRounds = document.getElementById('validRounds');

  // Patterns
  const titlePattern = /在线交谈开始于\s(.*)|Conversation with (\d+)/;
  // 支持英文冒号 ":" + 中文冒号 "："
  const messageStartPattern = /^\s*(\(\d{2}:\d{2}:\d{2}\))\s(.*?)\s*[:：]\s([\s\S]*)/;
  const systemMessagePattern = /^\s*(\(\d{2}:\d{2}:\d{2}\))\s\*\*\*(.*)\*\*\*/;
  const attachmentLinePattern = /^(.*uploaded:)(.*)\.png/;

  function renderText(text, type) {
    if (!text || text.trim() === '') return;

    const messageDiv = document.createElement('div');

    if (type === 'title') {
      messageDiv.className = 'text-center text-xs text-gray-500 font-semibold mb-2';
      messageDiv.textContent = text;
    } else if (type === 'system') {
      messageDiv.className = 'text-center text-gray-400 my-1';
      messageDiv.textContent = text;
    } else if (type === 'attachment') {
      messageDiv.className = 'flex items-center text-gray-800 my-1';
      messageDiv.innerHTML = `<i class="fas fa-paperclip text-gray-500 mr-2"></i><span>${text}</span>`;
    } else {
      messageDiv.className = 'whitespace-pre-wrap text-gray-800';
      messageDiv.textContent = text;
    }

    chatLog.appendChild(messageDiv);
  }

  // ===== Metrics helpers =====
  function hhmmssToSeconds(hhmmss) {
    const m = hhmmss.match(/^(\d{2}):(\d{2}):(\d{2})$/);
    if (!m) return null;
    const h = parseInt(m[1], 10);
    const mi = parseInt(m[2], 10);
    const s = parseInt(m[3], 10);
    return h * 3600 + mi * 60 + s;
  }

  function formatSecondsToHHMMSS(totalSeconds) {
    const sec = Math.max(0, Math.round(totalSeconds));
    const h = String(Math.floor(sec / 3600)).padStart(2, '0');
    const m = String(Math.floor((sec % 3600) / 60)).padStart(2, '0');
    const s = String(sec % 60).padStart(2, '0');
    return `${h}:${m}:${s}`;
  }

  // 用户识别（按你的票据表现）
  function isUserSpeaker(speaker) {
    const sp = (speaker || '').toLowerCase().trim();
    return (
      sp.includes('web user') ||
      sp.includes('end-user') ||
      sp.includes('requester') ||
      sp.includes('visitor') ||
      sp.includes('customer') ||
      sp.includes('用户')
    );
  }

  // 系统过滤（只过滤 CrabX）
  function isSystemOrBotSpeaker(speaker) {
    const sp = (speaker || '').toLowerCase().trim();
    return sp === 'crabx';
  }

  // 解析 plain_body 里的 (HH:MM:SS) 说话人: 内容
  function parseEventsFromPlainBody(fullText) {
    const events = [];
    const lines = fullText.split('\n');

    // 同时支持 ":" 和 "："
    const lineRe = /^\s*\((\d{2}:\d{2}:\d{2})\)\s*(.+?)\s*[:：]\s*(.*)$/;

    for (const raw of lines) {
      const line = raw.trim();
      const m = line.match(lineRe);
      if (!m) continue;

      const tSec = hhmmssToSeconds(m[1]);
      if (tSec === null) continue;

      const speaker = (m[2] || '').trim();
      const text = (m[3] || '').trim();
      events.push({ tSec, speaker, text });
    }

    events.sort((a, b) => a.tSec - b.tSec);
    return events;
  }

  // 只统计：用户发言 -> 下一条专员回复（客服先开场白不算）
// 口径：用户每条消息都算一轮（不合并连发）
// 规则：每条用户消息都入队，遇到第一条专员回复就结算“最早那条用户消息”
function calcAvgAgentResponseSeconds(events) {
  // 1) 找到“专员已接入”的标记：第一条【非用户 + 非系统】消息（一般就是开场白）
  const firstAgentIdx = events.findIndex(ev => {
    const speaker = ev.speaker;
    if (isSystemOrBotSpeaker(speaker)) return false; // CrabX 系统不算
    if (isUserSpeaker(speaker)) return false;        // 用户不算
    return true;                                     // 其他都当专员（Lisa/Peter/Agent名）
  });

  // 如果整段里都没找到专员消息，就无法计算
  if (firstAgentIdx === -1) return { avgSec: null, rounds: 0 };

  // 2) 从专员开场白之后开始统计
  let waitingUserTime = null; // 注意：我们要“用户连发取第一条”，所以只在 null 时赋值
  const durations = [];

  for (let i = firstAgentIdx + 1; i < events.length; i++) {
    const ev = events[i];
    const speaker = ev.speaker;

    // 跳过系统
    if (isSystemOrBotSpeaker(speaker)) continue;

    if (isUserSpeaker(speaker)) {
      // 用户连发：只记录第一条，不覆盖
      if (waitingUserTime === null) waitingUserTime = ev.tSec;
      continue;
    }

    // 专员消息：如果前面有用户在等，就结算一轮
    if (waitingUserTime !== null) {
      const d = ev.tSec - waitingUserTime;
      if (d >= 0) durations.push(d);
      waitingUserTime = null; // 清空，等待下一轮用户
    } else {
      // 专员自己连发且用户没说话：不算
    }
  }

  if (durations.length === 0) return { avgSec: null, rounds: 0 };
  const sum = durations.reduce((a, b) => a + b, 0);
  return { avgSec: sum / durations.length, rounds: durations.length };
}

  function showMetrics(avgSec, rounds) {
    if (!metricsBox || !avgAgentReply || !validRounds) return;
    metricsBox.classList.remove('hidden');
    validRounds.textContent = `${rounds} 次`;
    avgAgentReply.textContent = avgSec === null ? '--' : formatSecondsToHHMMSS(avgSec);
  }

  function hideMetrics() {
    if (!metricsBox) return;
    metricsBox.classList.add('hidden');
    if (avgAgentReply) avgAgentReply.textContent = '--';
    if (validRounds) validRounds.textContent = '--';
  }

  async function fetchChatRecords() {
    const ticketId = ticketIdInput.value.trim();

    if (!ticketId) {
      statusMessage.textContent = '请输入一个有效的 Ticket ID。';
      return;
    }

    chatLog.innerHTML = '';
    statusMessage.textContent = '';
    hideMetrics();

    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'loading-message';
    loadingDiv.className = 'text-center text-gray-600 mt-24 text-sm flex flex-col items-center';
    loadingDiv.innerHTML = `<i class="fas fa-spinner fa-spin text-4xl" style="color:#F7931A;"></i><p>加载中...</p>`;
    chatLog.appendChild(loadingDiv);

    const workerUrl = 'https://crabxrecords.sokdana2233.workers.dev';
    const url = `${workerUrl}/api/v2/tickets/${ticketId}/comments.json`;

    try {
      const response = await fetch(url);
      loadingDiv.remove();

      if (!response.ok) {
        if (response.status === 404) throw new Error('Ticket ID 未找到，请检查ID是否正确。');
        throw new Error('网络请求失败，状态码: ' + response.status);
      }

      const data = await response.json();

      if (data && data.comments && data.comments.length > 0) {
        let fullText = '';

        const firstCommentTime = new Date(data.comments[0].created_at);
        const formattedDateTitle = `会话时间（UTC+8）：${firstCommentTime.toLocaleString('zh-CN', {
          timeZone: 'Asia/Shanghai',
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        })}`;
        renderText(formattedDateTitle, 'title');

        data.comments.forEach(comment => {
          if (comment && comment.plain_body) {
            fullText += comment.plain_body + '\n\n';
          }
        });

        fullText = fullText.replace(titlePattern, '').trim();

        // ===== 计算平均响应 =====
        const events = parseEventsFromPlainBody(fullText);
        const { avgSec, rounds } = calcAvgAgentResponseSeconds(events);
        showMetrics(avgSec, rounds);

        // ===== 渲染聊天 =====
        const lines = fullText.split('\n');
        let currentMessage = '';

        lines.forEach(line => {
          const t = line.trim();
          if (t.length === 0) {
            if (currentMessage.length > 0) {
              renderText(currentMessage, 'message');
              currentMessage = '';
            }
            return;
          }

          if (t.startsWith('URL:') || t.startsWith('类型：') || t.startsWith('Size:')) return;

          if (t.match(messageStartPattern)) {
            if (currentMessage.length > 0) renderText(currentMessage, 'message');
            currentMessage = t;
          } else if (t.match(systemMessagePattern)) {
            if (currentMessage.length > 0) renderText(currentMessage, 'message');
            renderText(t, 'system');
            currentMessage = '';
          } else if (t.match(attachmentLinePattern)) {
            const filenameMatch = t.match(attachmentLinePattern);
            if (filenameMatch && filenameMatch[2]) {
              const filename = filenameMatch[2].trim() + '.png';
              renderText(filename, 'attachment');
            }
          } else {
            currentMessage += '\n' + t;
          }
        });

        if (currentMessage.length > 0) renderText(currentMessage, 'message');

        chatLog.scrollTop = chatLog.scrollHeight;
      } else {
        chatLog.innerHTML = `<div class="text-center text-gray-600 mt-24">暂无数据...</div>`;
        hideMetrics();
      }
    } catch (error) {
      console.error('获取数据时发生错误:', error);
      statusMessage.textContent = '加载聊天记录失败。' + error.message;
      hideMetrics();

      chatLog.innerHTML = `
        <div class="text-center text-gray-600 mt-24 flex flex-col items-center">
          <img src="https://i.ibb.co/TD1Z7sxg/error-404.png" alt="无数据图标" class="mx-auto w-24 h-24 mb-4">
          <p class="text-base">Ticket ID 未找到，请检查ID是否正确。</p>
        </div>
      `;
    }
  }

  // bind
  fetchButton.addEventListener('click', fetchChatRecords);
  ticketIdInput.addEventListener('keypress', (event) => {
    if (event.key === 'Enter') {
      event.preventDefault();
      fetchChatRecords();
    }
  });
});
</script>

</body>
</html>
